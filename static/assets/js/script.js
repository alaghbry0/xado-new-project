'use strict';

let tg = null;
let telegramId = null;

document.addEventListener('DOMContentLoaded', () => {
    // ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
    window.addEventListener('error', function (event) {
        console.error("Error in script loading:", event.message);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.");
    });

    try {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Telegram WebApp
        tg = window.Telegram?.WebApp;

        if (!tg) {
            console.error("Telegram WebApp API not available.");
            alert("ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
            return;
        }

        // Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ready
        tg.ready(() => {
            console.log("Telegram WebApp is ready!");
            console.log("Full initDataUnsafe object:", tg.initDataUnsafe); // Ø§Ø®ØªØ¨Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (tg.initDataUnsafe?.user?.id) {
                telegramId = tg.initDataUnsafe.user.id;
                const username = tg.initDataUnsafe.user.username || "Unknown User";
                const fullName = `${tg.initDataUnsafe.user.first_name || ''} ${tg.initDataUnsafe.user.last_name || ''}`.trim();

                console.log("Telegram ID:", telegramId);
                console.log("Username:", username);
                console.log("Full Name:", fullName);

                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updateUserUI(fullName, username);

                // Ø¥Ø±Ø³Ø§Ù„ Telegram ID Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
                sendTelegramIDToServer(telegramId, username);
            } else {
                console.error("User data is not available after initialization.");
                alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
            }
        });
    } catch (error) {
        console.error("Error initializing Telegram WebApp:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.");
    }
});

// ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function updateUserUI(fullName, username) {
    const userNameElement = document.getElementById("user-name");
    const userUsernameElement = document.getElementById("user-username");

    if (userNameElement) userNameElement.textContent = fullName;
    if (userUsernameElement) userUsernameElement.textContent = username;
}

// Ø¥Ø±Ø³Ø§Ù„ Telegram ID Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
function sendTelegramIDToServer(telegramId, username) {
    console.log("Sending Telegram ID to server...");
    $.ajax({
        url: "/api/verify",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ telegramId, username }),
        success: function (response) {
            console.log("ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Telegram ID:", response);
        },
        error: function (error) {
            console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Telegram ID:", error);
        }
    });
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ¦Ø© Telegram
function checkTelegramEnvironment() {
    console.log("Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ¦Ø© Telegram WebApp...");
    if (!window.Telegram || !window.Telegram.WebApp) {
        console.error("Telegram WebApp ØºÙŠØ± Ù…ØªÙˆÙØ±. ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
        alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
        return false;
    }
    console.log("Telegram.WebApp Ù…ØªÙˆÙØ±. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Telegram WebApp.");
    return true;
}

// Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = function () {
    if (checkTelegramEnvironment()) {
        console.log("Starting Telegram WebApp initialization...");
        initializeTelegramWebApp();
    }
};

$(document).ready(function () {

    var body = $('body');
    var bodyParent = $('html');

    /* page load as iframe */
    if (self !== top) {
        body.addClass('iframe');
    } else {
        body.removeClass('iframe');
    }

    /* menu open close */
    $('.menu-btn').on('click', function () {
        if (body.hasClass('menu-open') === true) {
            body.removeClass('menu-open');
            bodyParent.removeClass('menu-open');
        } else {
            body.addClass('menu-open');
            bodyParent.addClass('menu-open');
        }

        return false;
    });

    body.on("click", function (e) {
        if (!$('.sidebar').is(e.target) && $('.sidebar').has(e.target).length === 0) {
            body.removeClass('menu-open');
            bodyParent.removeClass('menu-open');
        }

        return true;
    });



    /* menu style switch */
    $('#menu-pushcontent').on('change', function () {
        if ($(this).is(':checked') === true) {
            body.addClass('menu-push-content');
            body.removeClass('menu-overlay');
        }

        return false;
    });

    $('#menu-overlay').on('change', function () {
        if ($(this).is(':checked') === true) {
            body.removeClass('menu-push-content');
            body.addClass('menu-overlay');
        }

        return false;
    });

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ù…Ø«Ù„Ø©)
if (telegramId) {
    const userNameElement = document.getElementById("user-name");
    const userUsernameElement = document.getElementById("user-username");
    const avatarElement = document.querySelector(".avatar img");

    console.log("Telegram ID is valid. Proceeding to display user data...");

    if (userNameElement) {
        userNameElement.textContent = tg.initDataUnsafe?.user?.first_name || "Unknown";
    }
    if (userUsernameElement) {
        userUsernameElement.textContent = tg.initDataUnsafe?.user?.username || "Unknown User";
    }
    if (avatarElement) {
        avatarElement.src = tg.initDataUnsafe?.user?.photo_url || "assets/img/default-profile.jpg"; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    }
} else {
    console.error("Telegram ID is not defined. Make sure the WebApp is initialized properly.");
    alert("ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
}



    /* back page navigation */
    $('.back-btn').on('click', function () {
        window.history.back();

        return false;
    });

    /* Filter button */
    $('.filter-btn').on('click', function () {
        if (body.hasClass('filter-open') === true) {
            body.removeClass('filter-open');
        } else {
            body.addClass('filter-open');
        }

        return false;
    });
    $('.filter-close').on('click', function () {
        if (body.hasClass('filter-open') === true) {
            body.removeClass('filter-open');
        }
    });

    /* scroll y limited container height on page  */
    var scrollyheight = Number($(window).height() - $('.header').outerHeight() - $('.footer-info').outerHeight()) - 40;
    $('.scroll-y').height(scrollyheight);

});


$(window).on('load', function () {
    setTimeout(function () {
        $('.loader-wrap').fadeOut('slow');
    }, 500);

    /* coverimg */
    $('.coverimg').each(function () {
        var imgpath = $(this).find('img');
        $(this).css('background-image', 'url(' + imgpath.attr('src') + ')');
        imgpath.hide();
    })

    /* main container minimum height set */
    if ($('.header').length > 0 && $('.footer-info').length > 0) {
        var heightheader = $('.header').outerHeight();
        var heightfooter = $('.footer-info').outerHeight();

        var containerheight = $(window).height() - heightheader - heightfooter - 2;
        $('.main-container ').css('min-height', containerheight);
    }


    /* url path on menu */
    var path = window.location.href; // because the 'href' property of the DOM element is the absolute path
    $(' .main-menu ul a').each(function () {
        if (this.href === path) {
            $(' .main-menu ul a').removeClass('active');
            $(this).addClass('active');
        }
    });

});

$(window).on('scroll', function () {


    /* scroll from top and add class */
    if ($(document).scrollTop() > '10') {
        $('.header').addClass('active');
    } else {
        $('.header').removeClass('active');
    }
});


$(window).on('resize', function () {
    /* main container minimum height set */
    if ($('.header').length > 0 && $('.footer-info').length > 0) {
        var heightheader = $('.header').outerHeight();
        var heightfooter = $('.footer-info').outerHeight();

        var containerheight = $(window).height() - heightheader - heightfooter;
        $('.main-container ').css('min-height', containerheight);
    }
});

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
window.subscribe = function (subscriptionType) {
    console.log("Starting subscription process...");

    if (!tg) {
        console.error("Telegram WebApp API not initialized. tg:", tg);
        alert("ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
        return;
    }

    if (!telegramId) {
        console.error("Telegram ID not available. telegramId:", telegramId);
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: Telegram ID ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
    }

    const subscriptionData = {
        telegram_id: telegramId,
        subscription_type: subscriptionType
    };

    console.log("Data being sent for subscription:", subscriptionData);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API
    subscribeToApi(subscriptionData)
        .then((response) => {
            console.log("Subscription response:", response);
            alert(`ðŸŽ‰ ${response.message}`);
        })
        .catch((error) => {
            console.error("Error during subscription:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: " + (error.message || "Unknown Error"));
        });
};

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API
function subscribeToApi(data) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: "https://exaado-mini-app-c04ea61e41f4.herokuapp.com/api/subscribe",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                resolve(response);
            },
            error: function (error) {
                console.error("AJAX Error:", error);
                reject(new Error(error.responseJSON?.error || "Unknown Error"));
            }
        });
    });
}


// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
document.querySelectorAll('.subscribe-btn').forEach(button => {
    button.addEventListener('click', function () {
        const subscriptionType = this.getAttribute('data-subscription');
        subscribe(subscriptionType);
    });
});

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
function checkSubscription(telegramId) {
    if (!telegramId) {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: Telegram ID ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
    }

    $.ajax({
        url: `/api/check_subscription?telegram_id=${telegramId}`,
        type: "GET",
        success: function (response) {
            console.log("User subscriptions:", response.subscriptions); // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        },
        error: function (error) {
            console.error("Error checking subscription:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + (error.responseJSON?.error || "Unknown Error"));
        }
    });
}

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
window.renewSubscription = function (subscriptionType) {
    console.log("Starting renewal process...");

    if (!tg) {
        console.error("Telegram WebApp API not initialized. tg:", tg);
        alert("ÙŠØ±Ø¬Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Telegram.");
        return;
    }

    if (!telegramId) {
        console.error("Telegram ID not available. telegramId:", telegramId);
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: Telegram ID ØºÙŠØ± Ù…ØªÙˆÙØ±.");
        return;
    }

    const renewalData = {
        telegram_id: telegramId,
        subscription_type: subscriptionType
    };

    console.log("Data being sent for renewal:", renewalData);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API
    renewSubscriptionApi(renewalData)
        .then((response) => {
            console.log("Renewal response:", response);
            alert(`ðŸŽ‰ ${response.message}`);
        })
        .catch((error) => {
            console.error("Error during renewal:", error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: " + (error.message || "Unknown Error"));
        });
};

// Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ API
function renewSubscriptionApi(data) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: "https://exaado-mini-app-c04ea61e41f4.herokuapp.com/api/renew",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (response) {
                resolve(response);
            },
            error: function (error) {
                console.error("AJAX Error during renewal:", error);
                reject(new Error(error.responseJSON?.error || "Unknown Error"));
            }
        });
    });
}

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
document.querySelectorAll('.renew-btn').forEach(button => {
    button.addEventListener('click', function () {
        const subscriptionType = this.getAttribute('data-subscription');
        renewSubscription(subscriptionType);
    });
});

// Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", function () {
    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    document.querySelectorAll('.subscribe-btn').forEach(button => {
        button.addEventListener('click', function () {
            const subscriptionType = this.getAttribute('data-subscription');
            subscribe(subscriptionType);
        });
    });

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
    document.querySelectorAll('.renew-btn').forEach(button => {
        button.addEventListener('click', function () {
            const subscriptionType = this.getAttribute('data-subscription');
            renewSubscription(subscriptionType);
        });
    });
});

// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„
function showLoading() {
    const loader = document.getElementById("loader");
    if (loader) {
        loader.style.display = "block";
    }
}

function hideLoading() {
    const loader = document.getElementById("loader");
    if (loader) {
        loader.style.display = "none";
    }
}
